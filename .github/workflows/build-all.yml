name: Build All Platforms

on:
  workflow_dispatch:
    inputs:
      ios_build:
        description: 'Build iOS?'
        required: true
        default: true
        type: boolean
      android_build:
        description: 'Build Android?'
        required: true
        default: true
        type: boolean
      build_type:
        description: 'Build type'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - development

jobs:
  ios-build:
    name: Build iOS App
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.ios_build }}
    steps:
      - name: 🏗 Setup repository
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: 🏗 Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: 📦 Install dependencies
        run: npm install

      - name: 🚀 Build iOS app
        run: eas build --platform ios --profile ${{ github.event.inputs.build_type }} --non-interactive --no-wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: 📱 iOS Build info
        run: |
          echo "✅ iOS build spuštěn úspěšně!"
          echo "🔧 Build type: ${{ github.event.inputs.build_type }}"
          echo "📱 Platform: iOS"
          echo "⏳ Build běží na pozadí..."

  android-build:
    name: Build Android AAB
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.android_build }}
    steps:
      - name: 🏗 Setup repository
        uses: actions/checkout@v4

      - name: 🏗 Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: npm

      - name: 🏗 Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: 📦 Install dependencies
        run: npm install

      - name: 🚀 Build Android AAB
        run: eas build --platform android --profile ${{ github.event.inputs.build_type }} --non-interactive --no-wait
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: 📱 Android Build info
        run: |
          echo "✅ Android AAB build spuštěn úspěšně!"
          echo "🔧 Build type: ${{ github.event.inputs.build_type }}"
          echo "📱 Platform: Android"
          echo "📦 Output: AAB soubor"
          echo "⏳ Build běží na pozadí..."

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [ios-build, android-build]
    if: always()
    steps:
      - name: 📋 Build Summary
        run: |
          echo "🎯 Build Summary:"
          echo "=================="
          if [ "${{ github.event.inputs.ios_build }}" == "true" ]; then
            echo "✅ iOS build: Spuštěn"
          else
            echo "❌ iOS build: Přeskočen"
          fi
          
          if [ "${{ github.event.inputs.android_build }}" == "true" ]; then
            echo "✅ Android build: Spuštěn"
          else
            echo "❌ Android build: Přeskočen"
          fi
          
          echo "🔧 Build type: ${{ github.event.inputs.build_type }}"
          echo "📱 Všechny buildy byly spuštěny úspěšně!"
